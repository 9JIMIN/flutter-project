# 감자마켓

앱 개발 기록

## 08.26 ~ 09.03

> 이때는 기록을 거의 못 남겼다.

**multi_image_picker**

이거 쓸라면 `AndroidManifest.xml ` 파일에 권한을 추가해야한다.

**ListTile의 한계**

ListTile은 딱 정해져 있다. leading, title, subtitle, trailing...
그래서 단순하게 만들기에는 유용하지만,  
그래서 더 많은 정보를 넣고 하고 싶을때는 부적합 하다. 

그런 나를 위해 대안이 [여기에](https://api.flutter.dev/flutter/material/ListTile-class.html) 잘 설명이 되어있다. 

**GestureDetector**

그냥 만들면, 내부 위젯만 터치를 인식한다. 비어있는 부분은 눌러도 인식안됨.
그럴때, 
`behavior: HitTestBehavior.opaque` 를 추가한다. 

그럼, 해당 위젯 크기 전체가 인식됨. 

`HitTestBehavior.translucent` 는 터치인식이 오면 아래 위젯으로 내려감. 
그리고, 혹시나 아래에 같은 제스처가 있으면 하나만 인식이 됨. 

근데 이건 언제쓰는지 모르겠다. 

저 두개의 차이가 이해가 안되서 찾아보니, 나 같은 사람이 역시나 있다. 
[해당 이슈](https://github.com/flutter/flutter/issues/18450)  

**await void**

이미지를 선택하면, `List<Asset>` 이 만들어진다. 

이걸 firebase스토리지에 하나하나 넣어주는 걸 `forEach`로 처리하려고 했다.
근데 생각처럼 잘 안되었다. 

forEach에 적용시키는 함수가 async일 경우에는 forEach과정을 기다리지 않고, 다음 코드인 return 함수가 실행되어 버린다. 
그렇다고 forEach부분을 await할 수는 없다. 

리턴값이 없는 작업은 기다릴 수가 없다고 한다. 
[관련이슈](https://github.com/dart-lang/sdk/issues/28305)
[스택오버플로 답변](https://stackoverflow.com/questions/58939437/return-type-of-void-async-function-in-dart)

그럼 forEach에서 async를 쓸려면 어떻게 해야할까.

[나랑 정확하게 같은 상황에 대한 멋진 답변](https://stackoverflow.com/questions/51106934/my-async-call-is-returning-before-list-is-populated-in-foreach-loop)

forEach 대신 for를 쓰면 된다.

**탭을 옮겨다니면 rebuild가 계속된다.** 

그럴 필요가 없는데.. 
그래서 IndextStack으로 상태가 저장되도록 했다. 

그리고 새로 제품을 올리면 다시 빌드를 하고 싶다. 
그래서 다시 provider를 넣었다.. 어제는 필요없다고 지웠는데,  오늘은 다시 넣고 있네..

**Duration**

```dart
Duration(days: 1)
// 24:00:00.000000
// 시:분:초.밀리초
```

**스택으로 바꿈**

리스트 부분을 스택으로 바꿔서 넘치는 걸 방지했다. 
그리고 이렇게해야, 나중에 좋아요, 채팅을 넣을 수 있다. 마음에 들어~

**날짜와 가격**

별거 아닌 거 같은데, 오래걸렸다. 머리도 많이 굴렸음. 
원하는 대로 나오긴 하는데, 알고리즘이 마음에 들지는 않는다. 

설명하자면, 날짜는 초, 분, 시간, 개월, 년으로 변환해서 나오도록 했다. 
당근마켓은 '어제', '그저께' 뭐 그런것도 쓰던데, 나는 그렇게 안하고, 유튜브 댓글처럼 만들었다. 

가격도 콤마를 넣고, 10만원 이상은 글자를 넣어주었다. 
이게 별거 아닌 것 같은데, 마음처럼 안나와서 고생했다. 

지금은 일단, 이대로 쓸만하지만, 코드가 알아보기 힘들정도로 더러우니.. 
깔끔하게 정리하는 과정이 언젠가는 꼭 필요하다.

<p float='left'>
    <img src='./images/감자마켓/초기오버뷰.png' width='300'>
     => 
    <img src='./images/감자마켓/날짜와시간.png' width='300'>
</p>


## 09.04

**폼 위젯을 분리하고, 외부파일에서 validate, save를 해야한다.**

GlobalKey<FormState> 변수를 form위젯에 정의하지 말고, 
외부파일에 정의한다음, 폼이 있는 파일로 인자로 넘겨주면 된다.

그럼 외부파일에서 formkey.currentState.save() 를 부를 수 있다.

> 관련 [스택오버플로 답변](https://stackoverflow.com/questions/57721371/how-to-call-stateful-widgethave-form-method-from-another-dart-file-flutter) 
> 답변에 보면 super를 쓰는데, 난 저렇게 안해도 되던데? 저게 하는게 뭔지를 잘 모르겠다.



**업로드 상태를 보여주기**

- 방법 1. 스낵바

```dart
Scaffold.of(context).showSnackBar(
    SnackBar(
        content: Text('업로드 중...'),
    ),
); 
// 같은 Scaffold안에서는 이게 안된다. 
// Builder로 감싸서 하면, 가능.
Builder(
    builder: (context) => //..
)
```

만들고 보니, 마음에 안든다. 

- 방법 2. 화면 전체에 돌아가는 거 

[modal progress hud라고 다운 받았다.](https://pub.dev/packages/modal_progress_hud) 버전이 1을 넘는게 없구만..
암튼 사용법도 간단해서 이걸로 하기로 함. 
이 방법이 좋은게, 방법1은 바깥 함수에서 어떻게 부를지 머리 아팠는데. 근데, 이건 따로 `inAsyncCall` 인자가 있어서 간단하게 만들 수 있음.



**키보드 사라지게 하기**

`FocusScope.of(context).unfocus()`
`.of`라서 외부에서도 부를 수 있다. 

가격을 받을 때는 숫자만 들어오게 해야한다. 
문자를 아예 입력못하게 하는 방법이 있다. 

```dart
inputFormatters: <TextInputFormatter>[
    FilteringTextInputFormatter.digitsOnly
], // 이걸 폼필드에 넣어주면 된다.
```

그리고 받은 값은 언제나 `String`타입이다.
저렇게 해서 숫자만 받는다고 해도, 타입은 문자이다. 
validator, onSaved가 받는 인자도 모두 String이다.  



**사진이 없을때는 디폴트 사진을 넣어주기**

디폴트 사진으로는 감자 그림을 넣었다. 
이걸 먼저 스토리지에 올린다음, `DBHelper`에 디폴트 사진 url을 받는 메서드를 추가했다.

그리고 assets이 `null`일때,( `isEmpty`가 아니라, `null`이다.)
암튼 선택한 사진이 없을때, 저 사진을 받아서 쓰도록 했다. 



**사진 용량 줄이기**

```dart
ByteData byteData = await image.getByteData(quality: 50); // 퀄리티를 조절하면 된다. 디폴트 100
List<int> imageData = byteData.buffer.asUint8List();
final photoRef = ref.child(DateTime.now().toString() + '.jpg');
final finRef = await photoRef.putData(imageData).onComplete;
```



**db에 대한 고민**

product클래스에 id필드를 새로 만들어야겠다. 
find를 해야하는데, 할만한 필드가 없다. 

uuid 모듈을 받아서 랜덤 id를 만들었다.

> 이걸 하면서, 다시보니 users 콜렉션이 있는데, 이거랑 products랑 같은 관계니까. 
> products문서에 유저의 id를 저장하는 특별한 필드를 써야하는게 아닌가.. 하는 생각을 했다. 
>
> 근데 그렇게 만들려면 또 users콜렉션으로 요청을 보내야하고 그건 별론거 같아서 그냥 String으로 저장하기로 함.

아, 스토리지 디렉토리도 뭔가 마음에 안드는데..



**디테일 뷰 고치기**

일단, shop app만들던거를 복붙했다. 
Hero애니메이션도 추가함. 

근데, 이게 문제가 디폴트 route애니메이션이랑 겹치면서 이상하게 보임.
이건 내일 해야지~



## 09.05

**판매자 정보**

판매자 정보를 가져오기 위해서 일단 **유저 모델을 만들고**, **db에서 불러와 모델형태로 가져오는 메소드를 추가**했다. 
근데 클래스명을 `User`로 하니까, 이게 예약된 클래스인지 안되서, `Profile`로 바꿨다.

이건 굳이 provider를 안써도 될 것 같아서, dbhelper에서 바로 가져오기로 했다. 
FutureBuilder로  가져와서 넣었다.

그리고 `ListTile`로 판매자 정보를 보여줄려고 했는데, 이게 디폴트 패딩이 있는지, 마음에 안들어서 Row로 만들기로 했다. 

**좋아요 기능**

디테일 페이지에서 핵심되는 기능이다.

**색깔**

나중에 또 이런 앱을 만들때는 처음에 계획을 잘 세우자.
색깔이나, 데이터베이스 모델 등등 구조를 좀 잘 세웠으면 함.

왜냐하면 지금너무 삽질하고 있어서.. 

**BottomAppBar**

바닥에 가격하고 채팅하기 위젯이 고정되어있어야 한다. 
그래서 난 이걸 `Positioned`로 넣어야하나.. 했는데.

이걸 위한 위젯이 따로 있다. 
바로, `BottomAppBar`
플러터는 알면 알수록 대단..

**IconButton vs InkWell**

아이콘 버튼은 디폴트 크기가 있다. 그래서 이걸 바꿔줄려면 SizedBox로 감싸던가 해야하는데, 
InkWell은 그런거 안해도 된다. 

[스택오버플로](https://stackoverflow.com/questions/49211024/how-to-resize-height-and-width-of-an-iconbutton-in-flutter)

**머티어리얼 디자인**
[https://material.io/develop/flutter/components/app-bars-bottom](https://material.io/develop/flutter/components/app-bars-bottom)
여기 자주 들어가서 참고하면 좋을 듯.

**디테일 페이지 레이아웃**

일단, 오늘 레이아웃은 그럴듯하게 만들었다. 
아직, DB에 부족한게 많다. 유저정보나 물건 정보 관련해서..

그리고 앱바 부분에 제목을 보여주는 기능이랑, 
사진 넘기는 것도 못했다. 

유저 페이지나 채팅, 좋아요 기능 등등.. 아직은 정말 그냥 디자인만 따라했다. 
저 앱바 사진부분은 근데 어떻게 해야될지 모르겠네.. 가능한 건지도 모르겠고.

<img src='./images/감자마켓/디테일페이지1차.jpg' width=300>

## 09.06

**앱바 제목 보이기**

앱바의 타이틀이 스크롤을 제목을 가릴정도로 내렸을때 보여주고 싶었다. 

그렇게 할려면, 스크롤에 대한 값을 알아내야한다.
[미디엄 포스팅](https://medium.com/@diegoveloper/flutter-lets-know-the-scrollcontroller-and-scrollnotification-652b2685a4ac)을 참고해서 만들었다.

제목의 위치는 모든 제품이 동일하니까 0~ 380까지는 null 로 안보이다가, 
그 이후로 스크롤하여 제목이 가려질때 앱바에 제목이 뜨도록 했다. 

```dart
  final ScrollController _scrollController = ScrollController();
  bool title = false;

  void initState() {
    super.initState();
    _scrollController.addListener(() {
      if (_scrollController.offset > 380) {
        setState(() {
          title = true;
        });
      } else {
        setState(() {
          title = false;
        });
      }
    });
  }

  @override
  void dispose() {
    super.dispose();
    _scrollController.dispose();
  }
```

380으로 그냥 주는건 잘못된거다. 
다른 기기에서 테스트는 해봐야 겠지만, 

일단 원하는대로 구현은 되서 기쁘다.

**사진목록 넘기기**

사진을 한장한장 넘기는 기능을 넣어야했다. 
이걸 Carousel 케러셀이라고 한다. 회전목마라는 뜻.

암튼 이걸 위한 패키지를 받았다. 
그리고 Hero에 child로 넣어주었다. 
Stack으로 몇번째 사진인지 보여주는 기능도 넣었다. 

다행히 잘 작동했다. 

사진 비율을 맞추는 것이 힘들었는데, 옵션의 인자를 조정하다보니 어쩌다 맞춰졌다.

디테일 페이지를 만든다고, 여러모로 새로운 것도 많이 찾아보고 배울 수 있었다.
진짜 당근마켓의 그런 기능들을 하나하나 채워나가는 것이 뿌듯하다.



## 계획

- 삭제한 문서는 업데이트가 안되는 듯. 수정하거나 한 요소도 refresh하면 반영되도록 해야할 듯.
- 가격 넣을때 콤마를 추가하던가 한글로 쉽게 보여지게 하기
- 제품 정보에 카테고리 추가

- 라우팅 에니메이션 수정

- 사진 누르면 전체화면 보기